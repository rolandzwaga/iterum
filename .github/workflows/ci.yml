name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release
  # ccache settings (used by Linux build)
  CCACHE_MAXSIZE: 500M
  CCACHE_COMPRESS: true
  CCACHE_COMPRESSLEVEL: 6
  # sccache settings (used by macOS build)
  SCCACHE_GHA_ENABLED: "true"

jobs:
  build-windows:
    name: Windows (MSVC)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Cache CMake FetchContent downloads
      - name: Cache FetchContent
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: fetchcontent-${{ runner.os }}-${{ hashFiles('tests/CMakeLists.txt') }}
          restore-keys: |
            fetchcontent-${{ runner.os }}-

      # Note: sccache/ccache with Ninja causes PDB conflicts with VSTGUI's /Zi flag
      # Visual Studio generator handles PDB files correctly via mspdbsrv.exe
      - name: Configure CMake
        run: cmake -S . -B build -G "Visual Studio 17 2022" -A x64

      - name: Build Tests
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target dsp_tests approval_tests --parallel

      - name: Build Plugin and Validator
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target Iterum validator --parallel

      - name: Run Tests
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure --exclude-regex "vst3_validator_extensive"

      - name: Run VST3 Validator (Extensive)
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "vst3_validator_extensive"

      - name: Upload Plugin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Iterum-Windows-x64
          path: build/VST3/${{ env.BUILD_TYPE }}/Iterum.vst3
          if-no-files-found: warn

  build-macos:
    name: macOS (Clang)
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Install Ninja build system (faster than Xcode generator)
      - name: Install Ninja
        run: brew install ninja

      # Setup sccache with native GitHub Actions cache backend
      # sccache works with Ninja generator and supports Objective-C++ (VSTGUI)
      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9

      # Cache CMake FetchContent downloads
      - name: Cache FetchContent
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: fetchcontent-${{ runner.os }}-${{ hashFiles('tests/CMakeLists.txt') }}
          restore-keys: |
            fetchcontent-${{ runner.os }}-

      # Use Ninja generator with sccache for compiler caching
      # CMAKE_OBJCXX_COMPILER_LAUNCHER is supported in CMake 3.16+ for Objective-C++
      - name: Configure CMake
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_C_COMPILER_LAUNCHER=sccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=sccache \
            -DCMAKE_OBJC_COMPILER_LAUNCHER=sccache \
            -DCMAKE_OBJCXX_COMPILER_LAUNCHER=sccache

      - name: Build Tests
        run: cmake --build build --target dsp_tests approval_tests --parallel

      - name: Build Plugin and Validator
        run: cmake --build build --target Iterum validator --parallel

      - name: Run Tests
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure --exclude-regex "vst3_validator_extensive"

      - name: Run VST3 Validator (Extensive)
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "vst3_validator_extensive"

      # Show sccache statistics for debugging cache effectiveness
      - name: Show sccache stats
        if: always()
        run: ${SCCACHE_PATH} --show-stats

      - name: Upload Plugin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Iterum-macOS
          path: build/VST3/${{ env.BUILD_TYPE }}/Iterum.vst3
          if-no-files-found: warn

  # Linux build (optional per constitution - Platform Support Matrix)
  build-linux:
    name: Linux (GCC)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Cache apt packages
      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: >-
            ninja-build libx11-dev libxcb1-dev libxkbcommon-x11-dev libx11-xcb-dev
            libxcb-util1 libxcb-util-dev libxcb-keysyms1-dev libxcb-cursor-dev
            libxcb-xkb-dev libxkbcommon-dev libfontconfig1-dev libfreetype6-dev
            libcairo2-dev libgtkmm-3.0-dev libsqlite3-dev
          version: 1.0

      # Cache ccache data
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: linux-gcc-${{ env.BUILD_TYPE }}
          max-size: ${{ env.CCACHE_MAXSIZE }}

      # Cache CMake FetchContent downloads
      - name: Cache FetchContent
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: fetchcontent-${{ runner.os }}-${{ hashFiles('tests/CMakeLists.txt') }}
          restore-keys: |
            fetchcontent-${{ runner.os }}-

      - name: Configure CMake
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build Tests
        run: cmake --build build --target dsp_tests approval_tests --parallel

      - name: Build Plugin and Validator
        run: cmake --build build --target Iterum validator --parallel

      - name: Run Tests
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure --exclude-regex "vst3_validator_extensive"

      - name: Run VST3 Validator (Extensive)
        run: ctest --test-dir build -C ${{ env.BUILD_TYPE }} --output-on-failure -R "vst3_validator_extensive"

      - name: Upload Plugin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Iterum-Linux-x64
          path: build/VST3/${{ env.BUILD_TYPE }}/Iterum.vst3
          if-no-files-found: warn
